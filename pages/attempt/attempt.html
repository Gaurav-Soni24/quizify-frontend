<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Attempt Quiz</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Radio+Canada+Big:ital,wght@0,400..700;1,400..700&family=Sour+Gummy:ital,wght@0,100..900;1,100..900&display=swap"
      rel="stylesheet"
    />

    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        background-image: url(bg.png);
        background-size: cover;
        background-position: center;
        background-repeat: no-repeat;
        background-attachment: fixed;
        display: flex;
        justify-content: center;
        align-items: center;
        height: 100vh;
        color: #242526;
        font-family: "Sour Gummy", sans-serif;
        
      }

      .container {
        width: 95%;
        max-width: 1200px;
        margin: 20px auto;
        padding: 2rem;
        min-height: 90vh;
        max-height: 95vh;
        overflow-y: auto;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        
      }

      .quiz-layout {
        display: flex;
        gap: 20px;
      }

      .question-palette {
        width: 250px;
        padding: 15px;
        background: #f5f5f5;
        border-radius: 8px;
      }

      .palette-btn {
        width: 40px;
        height: 40px;
        margin: 5px;
        border: 1px solid #ddd;
        border-radius: 5px;
        background: white;
        cursor: pointer;
      }

      .palette-btn.active {
        background: #007bff;
        color: white;
      }

      .palette-btn.answered {
        background: #28a745;
        color: white;
      }

      .question {
        display: none; /* Hide all questions by default */
      }

      .question.active {
        display: block; /* Show only active question */
      }

      /* Navigation buttons */
      .question-nav {
        display: flex;
        justify-content: space-between;
        margin-top: 20px;
      }

      /* Mobile styles */
      @media (max-width: 768px) {
        .quiz-layout {
          flex-direction: column;
        }

        .question-palette {
          display: none; /* Hide palette on mobile */
        }

        .question {
          display: block; /* Show all questions on mobile */
          margin-bottom: 30px;
          padding-bottom: 20px;
          border-bottom: 1px solid #ddd;
        }

        .question-nav {
          display: none; /* Hide navigation on mobile */
        }
      }

      .results-capture {
        padding: 20px;
        background: white;
      }

      .download-btn {
        margin-top: 20px;
        padding: 10px 20px;
        background: #007bff;
        color: white;
        border: none;
        border-radius: 5px;
        cursor: pointer;
      }

      .quiz-title {
        text-align: center;
        padding: 20px;
        border-bottom: 1px solid #ddd;
      }

      .quiz-description {
        text-align: center;
        padding: 10px;
      }

      /* Section 1 Styles */
      #section-1 {
        width: 100%;
        max-width: 600px;
        padding: 2rem;
        border-radius: 15px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      }

      #section-1 h1 {
        color: #242526;
        font-size: 2.2rem;
        background: transparent;
        margin-bottom: 0.5rem;
        text-align: center;
      }

      #section-1 p {
        color: #666;
        text-align: center;
        margin-bottom: 2rem;
        font-size: 1.1rem;
      }

      #section-1 h2 {
        color: #242526;
        font-size: 1.5rem;
        margin-bottom: 1.5rem;
        padding-bottom: 0.5rem;
        border-bottom: 2px solid #f2808b;
      }

      .form-field {
        margin-bottom: 1.5rem;
      }

      .form-field label {
        display: block;
        margin-bottom: 0.5rem;
        color: #242526;
        font-weight: 500;
      }

      .form-field input,
      .form-field select,
      .form-field textarea {
        width: 100%;
        padding: 0.75rem;
        border: 2px solid #e1e1e1;
        border-radius: 8px;
        font-size: 1rem;
        transition: all 0.3s ease;
      }

      .form-field input:focus,
      .form-field select:focus,
      .form-field textarea:focus {
        border-color: #f2808b;
        outline: none;
        box-shadow: 0 0 0 3px rgba(242, 128, 139, 0.1);
      }

      .form-field textarea {
        min-height: 100px;
        resize: vertical;
      }

      #details-form button[type="submit"] {
        width: 100%;
        padding: 1rem;
        background: #f2808b;
        color: white;
        border: none;
        border-radius: 8px;
        font-size: 1.1rem;
        font-weight: 600;
        cursor: pointer;
        transition: background-color 0.3s ease;
        margin-top: 1rem;
      }

      #details-form button[type="submit"]:hover {
        background: #e66d78;
      }

      /* Responsive adjustments */
      @media (max-width: 768px) {
        #section-1 {
          padding: 1.5rem;
        }

        #section-1 h1 {
          font-size: 1.8rem;
        }

        .form-field {
          margin-bottom: 1rem;
        }
      }

      /* Section 2 Styles */
      #section-2 {
        width: 100%;
        max-width: 600px;
        background: white;
        padding: 2.5rem;
        border-radius: 15px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      }

      #section-2 h2 {
        color: #242526;
        font-size: 2rem;
        margin-bottom: 1.5rem;
        text-align: center;
        padding-bottom: 0.5rem;
        border-bottom: 2px solid #f2808b;
      }

      .instructions {
        background: #f8f9fa;
        padding: 1.5rem;
        border-radius: 10px;
        margin-bottom: 2rem;
      }

      .instructions ul {
        list-style-type: none;
        padding: 0;
      }

      .instructions li {
        position: relative;
        padding: 0.75rem 0 0.75rem 2rem;
        color: #4a4a4a;
        font-size: 1.1rem;
        line-height: 1.5;
        border-bottom: 1px solid #e9ecef;
      }

      .instructions li:last-child {
        border-bottom: none;
      }

      .instructions li::before {
        content: "•";
        color: #f2808b;
        font-size: 1.5rem;
        position: absolute;
        left: 0.5rem;
        top: 0.5rem;
      }

      #section-2 label {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        margin: 1.5rem 0;
        padding: 1rem;
        background: #fff3f4;
        border-radius: 8px;
        cursor: pointer;
        transition: background-color 0.2s ease;
      }

      #section-2 label:hover {
        background: #ffe6e8;
      }

      #agree-checkbox {
        width: 20px;
        height: 20px;
        border: 2px solid #f2808b;
        border-radius: 4px;
        cursor: pointer;
      }

      #start-quiz-btn {
        width: 100%;
        padding: 1rem;
        background: #f2808b;
        color: white;
        border: none;
        border-radius: 8px;
        font-size: 1.1rem;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        margin-top: 1.5rem;
      }

      #start-quiz-btn:hover:not(:disabled) {
        background: #e66d78;
        transform: translateY(-2px);
      }

      #start-quiz-btn:disabled {
        background: #ccc;
        cursor: not-allowed;
        opacity: 0.7;
      }

      /* Responsive adjustments */
      @media (max-width: 768px) {
        #section-2 {
          padding: 1.5rem;
        }

        #section-2 h2 {
          font-size: 1.8rem;
        }

        .instructions li {
          font-size: 1rem;
          padding: 0.5rem 0 0.5rem 1.75rem;
        }

        .instructions li::before {
          font-size: 1.25rem;
          top: 0.4rem;
        }
      }

      /* Section 3 Styles */
      #section-3 {
        width: 100%;
        max-width: 800px;
        background: white;
        padding: 2.5rem;
        border-radius: 15px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      }

      #section-3 h2 {
        color: #242526;
        font-size: 1.8rem;
        margin-bottom: 1.5rem;
        text-align: center;
        padding-bottom: 0.5rem;
        border-bottom: 2px solid #f2808b;
      }

      .quiz-layout {
        display: flex;
        gap: 2rem;
      }

      /* Question Palette Styles */
      .question-palette {
        width: 200px;
        padding: 1.5rem;
        background: #f8f9fa;
        border-radius: 10px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
      }

      .palette-btn {
        width: 40px;
        height: 40px;
        margin: 5px;
        border: 2px solid #e1e1e1;
        border-radius: 8px;
        background: white;
        cursor: pointer;
        font-weight: 500;
        transition: all 0.3s ease;
      }

      .palette-btn:hover {
        border-color: #f2808b;
        background: #fff3f4;
      }

      .palette-btn.active {
        background: #f2808b;
        color: white;
        border-color: #f2808b;
      }

      .palette-btn.answered {
        background: #04AA6D;
        color: white;
        border-color: #04AA6D;
      }

      /* Question Container Styles */
      .question-container {
        flex: 1;
        padding: 1.5rem;
        background: #fff;
        border-radius: 10px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
      }

      .question {
        margin-bottom: 2rem;
      }

      .question h3 {
        color: #242526;
        font-size: 1.2rem;
        margin-bottom: 1rem;
      }

      /* Options Styles */
      .options label {
        display: block;
        padding: 1rem;
        margin-bottom: 0.8rem;
        background: #f8f9fa;
        border: 2px solid #e1e1e1;
        border-radius: 8px;
        cursor: pointer;
        transition: all 0.3s ease;
      }

      .options label:hover {
        background: #fff3f4;
        border-color: #f2808b;
      }

      .options input[type="radio"],
      .options input[type="checkbox"] {
        margin-right: 10px;
      }

      /* Text/Number Input Styles */
      .text-input,
      input[type="number"] {
        width: 100%;
        padding: 0.8rem;
        border: 2px solid #e1e1e1;
        border-radius: 8px;
        font-size: 1rem;
        transition: all 0.3s ease;
      }

      .text-input:focus,
      input[type="number"]:focus {
        border-color: #f2808b;
        outline: none;
        box-shadow: 0 0 0 3px rgba(242, 128, 139, 0.1);
      }

      /* Navigation Buttons */
      .question-nav {
        display: flex;
        justify-content: space-between;
        margin-top: 2rem;
        padding-top: 1rem;
        border-top: 1px solid #e1e1e1;
      }

      .nav-btn {
        padding: 0.8rem 1.5rem;
        background: #f2808b;
        color: white;
        border: none;
        border-radius: 8px;
        font-size: 1rem;
        cursor: pointer;
        transition: background-color 0.3s ease;
      }

      .nav-btn:hover {
        background: #e66d78;
      }

      .nav-btn:disabled {
        background: #ccc;
        cursor: not-allowed;
      }

      #submit-quiz-btn {
        width: 100%;
        padding: 1rem;
        margin-top: 2rem;
        background: #04AA6D;
        color: white;
        border: none;
        border-radius: 8px;
        font-size: 1.1rem;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
      }

      #submit-quiz-btn:hover {
        background: #059862;
        transform: translateY(-2px);
      }

      /* Responsive Design */
      @media (max-width: 768px) {
        #section-3 {
          padding: 1.5rem;
        }

        .quiz-layout {
          flex-direction: column;
        }

        .question-palette {
          width: 100%;
          margin-bottom: 1.5rem;
        }

        .palette-btn {
          width: 35px;
          height: 35px;
        }
      }

      /* Container adjustments */
      #section-1,
      #section-2,
      #section-3 {
        width: 100%;
        max-width: 800px;
        background: #f0f0f0;
        padding: 2rem;
        border-radius: 15px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        margin: 0 auto;
        max-height: 85vh;
        overflow-y: auto;
      }

      /* Scrollbar styling */
      #section-1::-webkit-scrollbar,
      #section-2::-webkit-scrollbar,
      #section-3::-webkit-scrollbar,
      .question-palette::-webkit-scrollbar,
      .container::-webkit-scrollbar {
        width: 8px;
      }

      #section-1::-webkit-scrollbar-track,
      #section-2::-webkit-scrollbar-track,
      #section-3::-webkit-scrollbar-track,
      .question-palette::-webkit-scrollbar-track,
      .container::-webkit-scrollbar-track {
        background: #f1f1f1;
        border-radius: 10px;
      }

      #section-1::-webkit-scrollbar-thumb,
      #section-2::-webkit-scrollbar-thumb,
      #section-3::-webkit-scrollbar-thumb,
      .question-palette::-webkit-scrollbar-thumb,
      .container::-webkit-scrollbar-thumb {
        background: #f2808b;
        border-radius: 10px;
      }

      /* Question palette adjustments */
      .question-palette {
        position: sticky;
        top: 0;
        height: auto;
        max-height: 70vh;
        overflow-y: auto;
        padding: 1rem;
      }

      .palette-container {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(40px, 1fr));
        gap: 8px;
        padding: 0.5rem;
      }

      /* Responsive adjustments */
      @media (max-width: 768px) {
        .container {
          width: 100%;
          padding: 1rem;
          margin: 0;
          border-radius: 0;
        }

        #section-1,
        #section-2,
        #section-3 {
          padding: 1rem;
          border-radius: 10px;
          margin: 0.5rem auto;
        }

        /* Form fields adjustments */
        .form-field {
          margin-bottom: 1rem;
        }

        .form-field input,
        .form-field select,
        .form-field textarea {
          padding: 0.6rem;
          font-size: 16px;
        }

        /* Instructions adjustments */
        .instructions {
          padding: 1rem;
        }

        .instructions li {
          font-size: 0.9rem;
          padding: 0.5rem 0 0.5rem 1.5rem;
        }

        /* Quiz layout adjustments */
        .quiz-layout {
          flex-direction: column;
        }

        .question-palette {
          position: relative;
          width: 100%;
          max-height: 150px;
          margin-bottom: 1rem;
          border-bottom: 2px solid #f2808b;
        }

        .palette-container {
          grid-template-columns: repeat(auto-fill, minmax(35px, 1fr));
        }

        .palette-btn {
          width: 35px;
          height: 35px;
          font-size: 0.9rem;
        }

        /* Question container adjustments */
        .question-container {
          padding: 1rem;
        }

        .options label {
          padding: 0.8rem;
          font-size: 0.9rem;
        }

        /* Navigation buttons adjustments */
        .question-nav {
          position: sticky;
          bottom: 0;
          background: white;
          padding: 1rem;
          box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.1);
        }

        .nav-btn {
          padding: 0.6rem 1rem;
          font-size: 0.9rem;
        }

        #submit-quiz-btn {
          position: sticky;
          bottom: 0;
          margin: 1rem 0;
          padding: 0.8rem;
        }
      }

      /* Tablet adjustments */
      @media (min-width: 769px) and (max-width: 1024px) {
        .container {
          width: 90%;
          padding: 1.5rem;
        }

        .quiz-layout {
          gap: 1rem;
        }

        .question-palette {
          width: 160px;
        }

        .palette-btn {
          width: 38px;
          height: 38px;
        }
      }

      /* Fixed header for sections */
      .section-header {
        top: 0;
        background: transparent ;
        padding: 1rem;
        z-index: 10;
        border-bottom: 2px solid #f2808b;
      }

      /* Sticky submit button */
      .submit-wrapper {
        position: sticky;
        bottom: 0;
        background: white;
        padding: 1rem;
        border-top: 1px solid #e1e1e1;
        margin-top: 2rem;
      }

      /* Loading state for buttons */
      .btn-loading {
        position: relative;
        pointer-events: none;
        opacity: 0.8;
      }

      .btn-loading::after {
        content: "";
        position: absolute;
        width: 20px;
        height: 20px;
        top: 50%;
        left: 50%;
        margin: -10px 0 0 -10px;
        border: 2px solid transparent;
        border-top-color: #ffffff;
        border-radius: 50%;
        animation: button-loading-spinner 1s ease infinite;
      }

      @keyframes button-loading-spinner {
        from {
          transform: rotate(0turn);
        }
        to {
          transform: rotate(1turn);
        }
      }

      /* Section 4 Styles */
      #section-4 {
        width: 100%;
        max-width: 800px;
        background: white;
        padding: 2.5rem;
        border-radius: 15px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        max-height: 85vh;
        overflow-y: auto;
      }

      #section-4 h2 {
        color: #242526;
        font-size: 2rem;
        margin-bottom: 1.5rem;
        text-align: center;
        padding-bottom: 0.5rem;
        border-bottom: 2px solid #f2808b;
      }

      .results-capture {
        background: white;
        border-radius: 10px;
        margin-bottom: 2rem;
      }

      .quiz-title {
        margin-bottom: 2rem;
        text-align: center;
      }

      .quiz-title h2 {
        color: #242526;
        font-size: 1.8rem;
        margin-bottom: 0.5rem;
      }

      .quiz-description {
        color: #666;
        font-size: 1.1rem;
      }

      .score {
        background: #f8f9fa;
        padding: 1.5rem;
        border-radius: 10px;
        margin-bottom: 2rem;
        text-align: center;
      }

      .score h3 {
        color: #242526;
        font-size: 1.5rem;
        margin-bottom: 1rem;
      }

      .score h4 {
        color: #f2808b;
        font-size: 2rem;
        margin-bottom: 0.5rem;
      }

      .result-item {
        padding: 1rem;
        margin-bottom: 1rem;
        border-radius: 8px;
        background: #f8f9fa;
      }

      .result-item.correct {
        border-left: 4px solid #04AA6D;
      }

      .result-item.incorrect {
        border-left: 4px solid #dc3545;
      }

      .result-item p {
        margin-bottom: 0.5rem;
        font-size: 1.1rem;
      }

      .download-btn {
        width: 100%;
        padding: 1rem;
        background: #f2808b;
        color: white;
        border: none;
        border-radius: 8px;
        font-size: 1.1rem;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
      }

      .download-btn:hover:not(:disabled) {
        background: #e66d78;
        transform: translateY(-2px);
      }

      .download-btn:disabled {
        background: #ccc;
        cursor: not-allowed;
        opacity: 0.7;
      }

      /* Responsive adjustments for section 4 */
      @media (max-width: 768px) {
        #section-4 {
          padding: 1.5rem;
        }

        #section-4 h2 {
          font-size: 1.6rem;
        }

        .quiz-title h2 {
          font-size: 1.4rem;
        }

        .quiz-description {
          font-size: 1rem;
        }

        .score h3 {
          font-size: 1.3rem;
        }

        .score h4 {
          font-size: 1.6rem;
        }

        .result-item {
          padding: 0.8rem;
        }

        .result-item p {
          font-size: 1rem;
        }

        .download-btn {
          padding: 0.8rem;
          font-size: 1rem;
        }
      }

      /* Question Palette Status Colors */
      .palette-btn.marked {
        background: #ffc107;
        color: #000;
        border-color: #ffc107;
      }

      .palette-btn.saved-marked {
        background: linear-gradient(45deg, #04AA6D 50%, #ffc107 50%);
        color: white;
        border-color: #04AA6D;
      }

      /* Legend for palette */
      .palette-legend {
        margin-top: 1rem;
        padding: 0.5rem;
        background: #f8f9fa;
        border-radius: 8px;
        font-size: 0.9rem;
      }

      .legend-item {
        display: flex;
        align-items: center;
        margin: 0.5rem 0;
      }

      .legend-color {
        width: 20px;
        height: 20px;
        margin-right: 0.5rem;
        border-radius: 4px;
      }

      .legend-color.not-visited {
        background: white;
        border: 2px solid #e1e1e1;
      }

      .legend-color.answered {
        background: #04AA6D;
      }

      .legend-color.marked {
        background: #ffc107;
      }

      .legend-color.saved-marked {
        background: linear-gradient(45deg, #04AA6D 50%, #ffc107 50%);
      }

      /* Hide question controls in mobile view */
      @media (max-width: 768px) {
        .question-controls {
          display: none !important;  /* Use !important to ensure buttons are hidden */
        }

        /* Show only the main navigation buttons */
        .question-nav {
          display: flex !important;  /* Force display for navigation */
          position: fixed;
          bottom: 0;
          left: 0;
          right: 0;
          background: white;
          padding: 1rem;
          box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.1);
          z-index: 100;
          justify-content: space-between;
        }

        .nav-btn {
          min-width: 100px;  /* Ensure buttons have enough width */
          padding: 0.8rem;
          font-size: 0.9rem;
        }

        /* Adjust submit button position */
        #submit-quiz-btn {
          position: fixed;
          bottom: 70px;  /* Position above nav buttons */
          left: 0;
          right: 0;
          margin: 0;
          border-radius: 0;
          z-index: 100;
        }

        /* Add padding to container to prevent content from being hidden behind fixed buttons */
        #section-3 {
          padding-bottom: 140px;  /* Increased padding to account for fixed buttons */
        }
      }

      #quiz-timer {
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        font-family: "Radio Canada", sans-serif;
      }

      #quiz-timer.warning {
        background: #ffc107;
        animation: pulse 1s infinite;
      }

      @keyframes pulse {
        0% { transform: scale(1); }
        50% { transform: scale(1.05); }
        100% { transform: scale(1); }
      }
    </style>
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
  </head>
  <body>
    <div class="container">
      <!-- Section 1: Details Form (initially visible) -->
      <div id="section-1">
        <div class="section-header">
          <h1>Quiz Title</h1>
          <p>Quiz Description</p>
        </div>
        <div>
          <h2>Required details</h2>
          <form id="details-form">
            <!-- Form fields will be dynamically added here -->
          </form>
        </div>
      </div>

      <!-- Section 2: Instructions -->
      <div id="section-2" style="display: none">
        <h2>Quiz Instructions</h2>
        <div class="instructions">
          <ul>
            <li>Read all questions carefully before attempting</li>
            <li>You cannot go back to previous questions</li>
            <li>There are different types of questions: single choice, multiple choice, text, and numerical</li>
            <li>Submit your answers before the time runs out</li>
          </ul>
        </div>
        <label>
          <input type="checkbox" id="agree-checkbox" required />
          I have read and agree to follow all instructions
        </label>
        <button id="start-quiz-btn" disabled>Start Quiz</button>
      </div>

      <!-- Section 3: Quiz Questions (initially hidden) -->
      <div id="section-3" style="display: none">
        <div class="quiz-layout">
          <!-- Question Palette -->
          <div class="question-palette">
            <h3>Question Palette</h3>
            <div id="palette-container"></div>
          </div>

          <!-- Questions Container -->
          <div class="quiz-content">
            <div id="quiz-container">
              <!-- Questions will be rendered here -->
            </div>
          </div>
        </div>
        <button id="submit-quiz-btn">Submit Quiz</button>
      </div>

      <!-- Section 4: Results (initially hidden) -->
      <div id="section-4" style="display: none">
        <h2>Quiz Results</h2>
        <div id="results-container">
          <!-- Results will be rendered here -->
        </div>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/axios@0.21.1/dist/axios.min.js"></script>
    <script>
      const urlParams = new URLSearchParams(window.location.search);
      const id = urlParams.get("id");

      let quizData = null; // Global variable to store quiz data

      async function fetchQuizData(quizId) {
        try {
          const response = await axios.get(
            `https://quizify-backend-theta.vercel.app/public-quiz/${quizId}`
          );
          quizData = response.data.quiz; // Store the quiz data directly

          // Update quiz title and description
          document.querySelector("#section-1 h1").textContent = quizData.title;
          document.querySelector("#section-1 p").textContent = quizData.description;

          // Add timer if timeLimit exists
          if (quizData.timeLimit) {
            setupTimer(quizData.timeLimit * 60); // Convert minutes to seconds
          }

          // Shuffle questions if enabled
          if (quizData.settings?.shuffleQuestions) {  // Add optional chaining
            quizData.questions = shuffleArray([...quizData.questions]); // Create a copy before shuffling
          }

          // Update instructions
          updateInstructions();

          // Render the required fields
          renderRequiredFields(quizData.requiredFields);
        } catch (error) {
          console.error("Error fetching quiz data:", error);
          // Show error message to user
          alert("Failed to load quiz. Please try again later.");
        }
      }
      fetchQuizData(id);

      // Add a separate function to update instructions
      function updateInstructions() {
        const instructionsUl = document.querySelector('#section-2 .instructions ul');
        if (instructionsUl && quizData) {
          instructionsUl.innerHTML = `
            <li>Total marks: ${quizData.totalMarks || 0} marks</li>
            <li>Time limit: ${quizData.timeLimit || 0} minutes</li>
            <li>Passing score: ${quizData.passingScore || 0}%</li>
            <li>Number of attempts allowed: ${quizData.attemptsAllowed || 1}</li>
            ${quizData.teacherInstructions ? quizData.teacherInstructions.split('\n').map(instruction => 
              `<li>${instruction.trim()}</li>`
            ).join('') : ''}
          `;
        }
      }

      function renderRequiredFields(requiredFields) {
        const form = document.getElementById("details-form");
        form.innerHTML = ""; // Clear existing form fields

        const fieldLabels = {
          name: "Full Name",
          email: "Email",
          department: "Department",
          institution: "Institution",
          dob: "Date of Birth",
          gender: "Gender",
          address: "Address",
          nationality: "Nationality",
          phone: "Phone Number",
        };

        const fieldTypes = {
          name: "text",
          email: "email",
          department: "text",
          institution: "text",
          dob: "date",
          gender: "select",
          address: "textarea",
          nationality: "text",
          phone: "tel",
        };

        for (const [field, isRequired] of Object.entries(requiredFields)) {
          if (isRequired) {
            const fieldContainer = document.createElement("div");
            fieldContainer.className = "form-field";

            const label = document.createElement("label");
            label.setAttribute("for", field);
            label.textContent = fieldLabels[field];

            let input;
            if (field === "gender") {
              input = document.createElement("select");
              const options = ["Select Gender", "Male", "Female", "Other"];
              options.forEach((optionText) => {
                const option = document.createElement("option");
                option.value = optionText.toLowerCase();
                option.textContent = optionText;
                input.appendChild(option);
              });
            } else if (field === "address") {
              input = document.createElement("textarea");
              input.rows = 3;
            } else {
              input = document.createElement("input");
              input.type = fieldTypes[field];
            }

            input.id = field;
            input.name = field;
            input.required = true;

            fieldContainer.appendChild(label);
            fieldContainer.appendChild(input);
            form.appendChild(fieldContainer);
          }
        }
        const submitButton = document.createElement("button");
        submitButton.type = "submit";
        submitButton.innerHTML = "Continue";
        form.appendChild(submitButton);
      }

      // Modify the details form submit handler
      document
        .getElementById("details-form")
        .addEventListener("submit", function (e) {
          e.preventDefault();
          document.getElementById("section-1").style.display = "none";
          document.getElementById("section-2").style.display = "block";
        });

      // Handle instructions agreement
      document
        .getElementById("agree-checkbox")
        .addEventListener("change", function (e) {
          document.getElementById("start-quiz-btn").disabled =
            !e.target.checked;
        });

      // Handle starting the quiz
      document
        .getElementById("start-quiz-btn")
        .addEventListener("click", function () {
          if (!quizData) {
            alert("Quiz data is not loaded yet. Please wait.");
            return;
          }
          document.getElementById("section-2").style.display = "none";
          document.getElementById("section-3").style.display = "block";
          renderQuestions(quizData.questions);
        });

      let currentQuestion = 0;

      function renderQuestions(questions) {
        if (!questions || !Array.isArray(questions)) {
          console.error('Invalid questions data:', questions);
          return;
        }

        const container = document.getElementById("quiz-container");
        const paletteContainer = document.getElementById("palette-container");
        
        if (!container || !paletteContainer) {
          console.error('Required containers not found');
          return;
        }

        container.innerHTML = "";
        paletteContainer.innerHTML = "";

        questions.forEach((question, index) => {
          // Create question div
          const questionDiv = document.createElement("div");
          questionDiv.className = `question ${index === 0 ? "active" : ""}`;
          questionDiv.dataset.questionIndex = index;

          const questionText = document.createElement("p");
          questionText.textContent = `${index + 1}. ${question.text}`;
          questionDiv.appendChild(questionText);

          // Add marks display
          const marksDisplay = document.createElement("p");
          marksDisplay.className = "question-marks";
          marksDisplay.textContent = `(${question.marks} marks)`;
          marksDisplay.style.color = "#666";
          marksDisplay.style.fontSize = "0.9rem";
          marksDisplay.style.marginBottom = "1rem";
          questionDiv.appendChild(marksDisplay);

          switch (question.type) {
            case "single":
              renderSingleChoice(questionDiv, question.options, index);
              break;
            case "multiple":
              renderMultipleChoice(questionDiv, question.options, index);
              break;
            case "text":
              renderTextInput(questionDiv, index);
              break;
            case "integer":
              renderNumberInput(questionDiv, index);
              break;
          }

          container.appendChild(questionDiv);

          // Create palette button
          const paletteBtn = document.createElement("button");
          paletteBtn.className = "palette-btn";
          paletteBtn.textContent = index + 1;
          paletteBtn.addEventListener("click", () => navigateToQuestion(index));
          paletteContainer.appendChild(paletteBtn);

          // Add question controls
          updateQuestionControls(questionDiv, index);
        });

        // Add legend to palette
        addPaletteLegend();

        updateNavigationButtons();
      }

      function navigateToQuestion(index) {
        const questions = document.querySelectorAll(".question");
        const paletteBtns = document.querySelectorAll(".palette-btn");

        questions.forEach((q) => q.classList.remove("active"));
        paletteBtns.forEach((b) => b.classList.remove("active"));

        questions[index].classList.add("active");
        paletteBtns[index].classList.add("active");

        currentQuestion = index;
        updateNavigationButtons();
      }

      function updateNavigationButtons() {
        const prevBtn = document.getElementById("prev-btn");
        const nextBtn = document.getElementById("next-btn");
        const totalQuestions = quizData.questions.length;

        prevBtn.disabled = currentQuestion === 0;
        nextBtn.disabled = currentQuestion === totalQuestions - 1;
      }

      // Update answer tracking
      function updatePaletteStatus(questionIndex) {
        const paletteBtns = document.querySelectorAll(".palette-btn");
        paletteBtns[questionIndex].classList.add("answered");
      }

      // Modify input event listeners to track answered questions
      function addAnswerTracking(input, questionIndex) {
        input.addEventListener("change", () => {
          updatePaletteStatus(questionIndex);
        });
      }

      // Update the render functions to add answer tracking
      function renderSingleChoice(container, options, index) {
        const optionsDiv = document.createElement("div");
        optionsDiv.className = "options";

        options.forEach((option, optionIndex) => {
          const label = document.createElement("label");
          const input = document.createElement("input");
          input.type = "radio";
          input.name = `question-${index}`;
          input.value = option.text;
          input.id = `q${index}-option${optionIndex}`;

          label.appendChild(input);
          label.appendChild(document.createTextNode(option.text));
          optionsDiv.appendChild(label);
          addAnswerTracking(input, index);
        });

        container.appendChild(optionsDiv);
      }

      function renderMultipleChoice(container, options, index) {
        const optionsDiv = document.createElement("div");
        optionsDiv.className = "options";

        options.forEach((option, optionIndex) => {
          const label = document.createElement("label");
          const input = document.createElement("input");
          input.type = "checkbox";
          input.name = `question-${index}`;
          input.value = option.text;
          input.id = `q${index}-option${optionIndex}`;

          label.appendChild(input);
          label.appendChild(document.createTextNode(option.text));
          optionsDiv.appendChild(label);
          addAnswerTracking(input, index);
        });

        container.appendChild(optionsDiv);
      }

      function renderTextInput(container, index) {
        const input = document.createElement("input");
        input.type = "text";
        input.name = `question-${index}`;
        input.id = `question-${index}`;
        input.className = "text-input";
        input.placeholder = "Type your answer here";

        container.appendChild(input);
        addAnswerTracking(input, index);
      }

      function renderNumberInput(container, index) {
        const input = document.createElement("input");
        input.type = "number";
        input.name = `question-${index}`;
        input.id = `question-${index}`;
        input.className = "number-input";
        input.placeholder = "Enter your answer";

        container.appendChild(input);
        addAnswerTracking(input, index);
      }

      // Update collectAnswers to handle all question types
      function collectAnswers() {
        const answers = [];
        const questions = quizData.questions;
        let allQuestionsAnswered = true;
        let hasMarkedQuestions = false;

        questions.forEach((question, index) => {
          const paletteBtn = document.querySelectorAll('.palette-btn')[index];
          const isMarked = paletteBtn.classList.contains('marked');
          const isSavedMarked = paletteBtn.classList.contains('saved-marked');

          if (isMarked || isSavedMarked) {
            hasMarkedQuestions = true;
          }

          switch (question.type) {
            case "single":
              const singleSelected = document.querySelector(
                `input[name="question-${index}"]:checked`
              );
              if (!singleSelected) allQuestionsAnswered = false;
              answers.push({
                questionIndex: index,
                type: "single",
                answer: singleSelected ? singleSelected.value : null,
              });
              break;

            case "multiple":
              const multipleSelected = Array.from(
                document.querySelectorAll(
                  `input[name="question-${index}"]:checked`
                )
              ).map((input) => input.value);
              if (multipleSelected.length === 0) allQuestionsAnswered = false;
              answers.push({
                questionIndex: index,
                type: "multiple",
                answer: multipleSelected,
              });
              break;

            case "text":
              const textAnswer = document
                .querySelector(`#question-${index}`)
                .value.trim();
              if (!textAnswer) allQuestionsAnswered = false;
              answers.push({
                questionIndex: index,
                type: "text",
                answer: textAnswer,
              });
              break;

            case "integer":
              const numberAnswer = document.querySelector(
                `#question-${index}`
              ).value;
              if (!numberAnswer) allQuestionsAnswered = false;
              answers.push({
                questionIndex: index,
                type: "integer",
                answer: numberAnswer,
              });
              break;
          }
        });

        if (hasMarkedQuestions) {
          const proceed = confirm('You have marked questions for review. Do you still want to submit?');
          if (!proceed) return null;
        }

        if (!allQuestionsAnswered) {
          alert('Please answer all questions before submitting.');
          return null;
        }

        return answers;
      }

      // Update checkAnswers function
      function checkAnswers(answers, questions) {
        const results = answers.map((answer) => {
          const question = questions[answer.questionIndex];
          let isCorrect = false;
          let correctAnswer = null;

          switch (question.type) {
            case "single":
              const correctOption = question.options.find(
                (opt) => opt.isCorrect
              );
              isCorrect = answer.answer === correctOption.text;
              correctAnswer = correctOption.text;
              break;

            case "multiple":
              const correctOptions = question.options
                .filter((opt) => opt.isCorrect)
                .map((opt) => opt.text);
              isCorrect =
                JSON.stringify(answer.answer.sort()) ===
                JSON.stringify(correctOptions.sort());
              correctAnswer = correctOptions;
              break;

            case "text":
              isCorrect =
                answer.answer.toLowerCase() ===
                question.correctAnswer.toLowerCase();
              correctAnswer = question.correctAnswer;
              break;

            case "integer":
              isCorrect = parseInt(answer.answer) === parseInt(question.correctAnswer);
              correctAnswer = question.correctAnswer;
              break;
          }

          return {
            questionIndex: answer.questionIndex,
            type: question.type,
            isCorrect,
            correctAnswer,
            userAnswer: answer.answer,
          };
        });

        return results;
      }

      // Update the submit quiz handler
      document.getElementById("submit-quiz-btn").addEventListener("click", function () {
        if (confirm("Are you sure you want to submit the quiz?")) {
          const answers = collectAnswers();
          if (answers) {
            const results = checkAnswers(answers, quizData.questions);

            // Generate and log the JSON result
            const resultJSON = generateResultJSON(results);

            // Continue with showing results
            document.getElementById("section-3").style.display = "none";
            document.getElementById("section-4").style.display = "block";
            showResults(results);
          }
        }
      });

      // Update generateResultJSON function
      function generateResultJSON(results) {
        // Get user details from the form
        const formData = new FormData(document.getElementById("details-form"));
        const userDetails = {};
        formData.forEach((value, key) => {
          userDetails[key] = value;
        });

        // Calculate score
        const totalQuestions = results.length;
        const correctAnswers = results.filter((r) => r.isCorrect).length;
        const percentage = ((correctAnswers / totalQuestions) * 100).toFixed(2);

        // Create detailed question results
        const questionResults = results.map((result, index) => {
          return {
            questionNumber: index + 1,
            questionText: quizData.questions[index].text,
            questionType: quizData.questions[index].type,
            userAnswer: result.userAnswer,
            correctAnswer: result.correctAnswer,
            isCorrect: result.isCorrect,
          };
        });

        // Create final result object
        const resultJSON = {
          quizId: quizData.quizId,
          quizTitle: quizData.title,
          quizDescription: quizData.description,
          userDetails: userDetails,
          submittedAt: new Date().toISOString(),
          score: {
            total: totalQuestions,
            correct: correctAnswers,
            percentage: parseFloat(percentage),
          },
          questions: questionResults,
        };

        console.log("Quiz Result JSON:", resultJSON);
        return resultJSON;
      }

      // Update showResults to handle all question types
      function showResults(results) {
        const resultsContainer = document.getElementById("results-container");
        resultsContainer.innerHTML = "";

        const captureDiv = document.createElement("div");
        captureDiv.className = "results-capture";

        // Add quiz title and description
        const titleDiv = document.createElement("div");
        titleDiv.className = "quiz-title";
        titleDiv.innerHTML = `
          <h2>${quizData.title}</h2>
          <p class="quiz-description">${quizData.description}</p>
        `;
        captureDiv.appendChild(titleDiv);

        // Calculate score
        const totalMarks = quizData.totalMarks;
        const earnedMarks = results.reduce((total, result, index) => {
          return total + (result.isCorrect ? quizData.questions[index].marks : 0);
        }, 0);
        const percentage = (earnedMarks / totalMarks) * 100;

        // Show score
        const scoreDiv = document.createElement("div");
        scoreDiv.className = "score";
        scoreDiv.innerHTML = `
          <h3>Quiz Results</h3>
          <h4>Your Score: ${earnedMarks}/${totalMarks}</h4>
          <p>Percentage: ${percentage.toFixed(2)}%</p>
          <p>Pass/Fail: ${percentage >= quizData.passingScore ? '✅ Passed' : '❌ Failed'}</p>
        `;
        captureDiv.appendChild(scoreDiv);

        // Show detailed results only if enabled in settings
        if (quizData.settings.showAnswers) {
          results.forEach((result, index) => {
            const resultDiv = document.createElement("div");
            resultDiv.className = `result-item ${result.isCorrect ? "correct" : "incorrect"}`;

            const question = quizData.questions[index];
            resultDiv.innerHTML = `
              <p>Question ${index + 1} (${question.marks} marks): ${result.isCorrect ? "✅ Correct" : "❌ Incorrect"}</p>
              <p>Question: ${question.text}</p>
              ${!result.isCorrect ? `
                <p>Your answer: ${result.userAnswer}</p>
                <p>Correct answer: ${result.correctAnswer}</p>
              ` : ''}
            `;

            captureDiv.appendChild(resultDiv);
          });
        }

        resultsContainer.appendChild(captureDiv);

        // Add download button
        const downloadBtn = document.createElement("button");
        downloadBtn.className = "download-btn";
        downloadBtn.innerHTML = "📥 Download Results";
        downloadBtn.onclick = () => downloadResults(captureDiv);
        resultsContainer.appendChild(downloadBtn);
      }

      // Function to download results as PNG
      async function downloadResults(element) {
        try {
          // Show loading state
          const downloadBtn = document.querySelector(".download-btn");
          downloadBtn.disabled = true;
          downloadBtn.innerHTML = "Generating image...";

          // Create canvas from the results div
          const canvas = await html2canvas(element, {
            backgroundColor: "white",
            scale: 2, // Higher quality
            logging: false,
            useCORS: true,
          });

          // Convert to image and download
          const image = canvas.toDataURL("image/png");
          const link = document.createElement("a");
          link.href = image;
          link.download = `quiz-results-${new Date()
            .toISOString()
            .slice(0, 10)}.png`;
          link.click();

          // Reset button state
          downloadBtn.disabled = false;
          downloadBtn.innerHTML = "📥 Download Results";
        } catch (error) {
          console.error("Error generating image:", error);
          alert("Failed to generate image. Please try again.");
        }
      }

      function updateQuestionControls(container, questionIndex) {
        const controlsDiv = document.createElement('div');
        controlsDiv.className = 'question-controls';
        controlsDiv.style.marginTop = '1rem';
        controlsDiv.style.display = 'flex';
        controlsDiv.style.gap = '0.5rem';

        // Save & Next button
        const saveNextBtn = document.createElement('button');
        saveNextBtn.className = 'nav-btn';
        saveNextBtn.textContent = 'Save & Next';
        saveNextBtn.onclick = () => {
          updatePaletteStatus(questionIndex, 'answered');
          if (questionIndex < quizData.questions.length - 1) {
            navigateToQuestion(questionIndex + 1);
          }
        };

        // Mark for Review button
        const markReviewBtn = document.createElement('button');
        markReviewBtn.className = 'nav-btn';
        markReviewBtn.style.background = '#ffc107';
        markReviewBtn.textContent = 'Mark for Review';
        markReviewBtn.onclick = () => {
          updatePaletteStatus(questionIndex, 'marked');
          if (questionIndex < quizData.questions.length - 1) {
            navigateToQuestion(questionIndex + 1);
          }
        };

        // Save & Mark for Review button
        const saveMarkBtn = document.createElement('button');
        saveMarkBtn.className = 'nav-btn';
        saveMarkBtn.style.background = '#04AA6D';
        saveMarkBtn.textContent = 'Save & Mark for Review';
        saveMarkBtn.onclick = () => {
          updatePaletteStatus(questionIndex, 'saved-marked');
          if (questionIndex < quizData.questions.length - 1) {
            navigateToQuestion(questionIndex + 1);
          }
        };

        controlsDiv.appendChild(saveNextBtn);
        controlsDiv.appendChild(markReviewBtn);
        controlsDiv.appendChild(saveMarkBtn);
        container.appendChild(controlsDiv);
      }

      // Update the palette status function
      function updatePaletteStatus(questionIndex, status) {
        const paletteBtns = document.querySelectorAll('.palette-btn');
        const btn = paletteBtns[questionIndex];
        
        // Remove all status classes first
        btn.classList.remove('answered', 'marked', 'saved-marked');
        
        // Add the new status class
        btn.classList.add(status);
      }

      // Add legend to palette
      function addPaletteLegend() {
        const palette = document.querySelector('.question-palette');
        const legend = document.createElement('div');
        legend.className = 'palette-legend';
        
        legend.innerHTML = `
          <div class="legend-item">
            <div class="legend-color not-visited"></div>
            <span>Not Visited</span>
          </div>
          <div class="legend-item">
            <div class="legend-color answered"></div>
            <span>Answered</span>
          </div>
          <div class="legend-item">
            <div class="legend-color marked"></div>
            <span>Marked for Review</span>
          </div>
          <div class="legend-item">
            <div class="legend-color saved-marked"></div>
            <span>Answered & Marked for Review</span>
          </div>
        `;
        
        palette.appendChild(legend);
      }

      // Add timer functionality
      function setupTimer(seconds) {
        const timerDiv = document.createElement('div');
        timerDiv.id = 'quiz-timer';
        timerDiv.style.cssText = `
          position: fixed;
          top: 20px;
          right: 20px;
          background: #f2808b;
          color: white;
          padding: 10px 20px;
          border-radius: 8px;
          font-size: 1.2rem;
          z-index: 1000;
        `;
        document.body.appendChild(timerDiv);

        let timeLeft = seconds;
        const timer = setInterval(() => {
          const minutes = Math.floor(timeLeft / 60);
          const secs = timeLeft % 60;
          timerDiv.textContent = `Time Left: ${minutes}:${secs.toString().padStart(2, '0')}`;

          if (timeLeft === 0) {
            clearInterval(timer);
            alert('Time is up! Submitting quiz...');
            document.getElementById('submit-quiz-btn').click();
          }
          timeLeft--;
        }, 1000);
      }

      // Add function to shuffle array
      function shuffleArray(array) {
        for (let i = array.length - 1; i > 0; i--) {
          const j = Math.floor(Math.random() * (i + 1));
          [array[i], array[j]] = [array[j], array[i]];
        }
        return array;
      }

      // Update the instructions section
      document.addEventListener('DOMContentLoaded', () => {
        const instructionsUl = document.querySelector('#section-2 .instructions ul');
        instructionsUl.innerHTML = `
          <li>Total marks: ${quizData?.totalMarks || 0} marks</li>
          <li>Time limit: ${quizData?.timeLimit || 0} minutes</li>
          <li>Passing score: ${quizData?.passingScore || 0}%</li>
          <li>Number of attempts allowed: ${quizData?.attemptsAllowed || 1}</li>
          ${quizData?.teacherInstructions?.split('\n').map(instruction => 
            `<li>${instruction}</li>`
          ).join('')}
        `;
      });
    </script>
  </body>
</html>
